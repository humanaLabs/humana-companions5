# üìä AN√ÅLISE DE MODELAGEM - TABELA SKILLS

**Data**: 08/01/2025  
**Objetivo**: Definir quais dados devem ser colunas fixas e quais devem estar em atributos JSON

---

## üéØ CONTEXTO DA FUNCIONALIDADE

A tabela **Skills** armazena as capacidades (habilidades) dos Companions, seguindo o padr√£o do AI SDK 5.0. 

### **Onde √© consumida:**
1. **Skill Selector** (`components/flow/core/skill-selector.tsx`)
   - Lista skills por companion
   - Filtra por categoria (THINK/ACT)
   - Exibe nome, descri√ß√£o, √≠cone, categoria
   - Drag and drop de skills para workflows

2. **Skills Sidebar** (`components/flow/core/skills-sidebar.tsx`)
   - Exibe skills do companion selecionado
   - Mostra nome, descri√ß√£o, tipo (PENSAR/EXECUTAR)
   - Suporta drag para canvas de workflow

3. **Skills Carousel** (`components/skills-carousel.tsx`)
   - Visualiza√ß√£o em cards
   - Exibe: nome, descri√ß√£o, categoria, √≠cone, usageCount
   - Bot√µes de editar/deletar
   - Badge de categoria com cores

4. **Chat V5** (`components/v5/chat/chat-v5-with-workers-integration.tsx`)
   - Converte skills em tools do AI SDK 5.0
   - Usa toolName, toolSchema, toolDescription para LLM
   - Executa skills durante chat

5. **Workflow Designer** (`components/flow/core/skills-flow-canvas.tsx`)
   - Adiciona skills como steps em workflows
   - Referencia skillId em WorkflowSteps

### **APIs que consomem:**
- `GET /api/skills` - Lista skills por organizationId, companionId, category
- `GET /api/v5/skills` - Skills ativas para Chat V5
- `GET /api/companions/skills` - Skills de companion espec√≠fico
- `GET /api/workflow-skills` - Skills vinculadas a workflows

---

## üìã AN√ÅLISE DE CAMPOS

### ‚úÖ **COLUNAS FIXAS (Headers)**
Campos usados em:
- Queries frequentes (WHERE, JOIN, ORDER BY)
- √çndices de busca
- Relacionamentos (Foreign Keys)
- Filtros de UI
- Queries de performance

| Campo | Tipo | Justificativa |
|-------|------|---------------|
| **skil_id** | UUID | PK, referenciado em WorkflowSteps, SkillExecutions |
| **skil_name** | VARCHAR(100) | ‚úÖ **Busca/filtro frequente**, √≠ndice √∫nico, exibido em UI |
| **skil_display_name** | VARCHAR(150) | ‚úÖ **Exibi√ß√£o principal na UI** (cards, selectors) |
| **skil_description** | TEXT | ‚úÖ **Exibido em cards, tooltips** - pode ser TEXT puro |
| **companion_id** | UUID | ‚úÖ **FK cr√≠tica**, filtro principal, JOIN com Companions |
| **organization_id** | UUID | ‚úÖ **FK cr√≠tica**, filtro de tenancy, √≠ndice |
| **skil_category** | VARCHAR(50) | ‚úÖ **Filtro frequente** (THINK/ACT, API, etc), √≠ndice |
| **skil_tool_name** | VARCHAR(100) | ‚úÖ **Identificador √∫nico da tool no AI SDK 5.0** |
| **skil_tool_description** | TEXT | ‚úÖ **Usado pelo LLM para entender quando usar a tool** |
| **skil_execution_type** | VARCHAR(20) | ‚úÖ **Filtro por tipo de execu√ß√£o**, √≠ndice (sync/async) |
| **skil_version** | VARCHAR(20) | ‚úÖ **Controle de vers√£o**, queries de compatibilidade |
| **skil_is_active** | BOOLEAN | ‚úÖ **Filtro cr√≠tico** (s√≥ buscar ativas), √≠ndice WHERE |
| **skil_is_deprecated** | BOOLEAN | ‚úÖ **Controle de ciclo de vida**, filtros |
| **skil_mcp_integration** | BOOLEAN | ‚úÖ **Filtro por tipo de integra√ß√£o** |
| **skil_has_mcp_mapping** | BOOLEAN | ‚úÖ **Filtro de configura√ß√£o MCP** |
| **mcp_server_id** | UUID | ‚úÖ **FK para MCPServers**, JOIN quando necess√°rio |
| **skil_max_retries** | INTEGER | ‚úÖ **Config de execu√ß√£o**, usado em l√≥gica |
| **skil_timeout_ms** | INTEGER | ‚úÖ **Config de execu√ß√£o**, usado em l√≥gica |
| **skil_cacheable** | BOOLEAN | ‚úÖ **L√≥gica de cache**, queries de otimiza√ß√£o |
| **skil_cache_expiry_ms** | INTEGER | ‚úÖ **Config de cache** |
| **skil_avg_execution_time_ms** | NUMERIC | ‚úÖ **M√©tricas de performance**, ORDER BY, dashboards |
| **skil_success_rate** | NUMERIC | ‚úÖ **M√©tricas de performance**, ORDER BY, √≠ndice |
| **skil_error_rate** | NUMERIC | ‚úÖ **M√©tricas de performance**, alertas |
| **skil_usage_count** | INTEGER | ‚úÖ **Contador de uso**, ORDER BY, √≠ndice, dashboard |
| **skil_last_used** | TIMESTAMP | ‚úÖ **Queries temporais**, ORDER BY recentes |
| **skil_attributes** | JSONB | ‚úÖ **Atributos JSONB** - tool_schema, metadata |
| **skil_created_at** | TIMESTAMP | ‚úÖ **Auditoria**, ORDER BY cronol√≥gico |
| **skil_updated_at** | TIMESTAMP | ‚úÖ **Auditoria**, trigger autom√°tico |

---

### üóÇÔ∏è **ATRIBUTOS JSON**
Campos que devem estar em JSONB por serem:
- Estruturas complexas/aninhadas
- Esquemas vari√°veis/extens√≠veis
- N√£o usados em queries diretas
- Configura√ß√µes espec√≠ficas por tipo

#### **1. toolSchema (JSONB)** ‚úÖ J√° est√° JSON
```json
{
  "type": "object",
  "properties": {
    "query": { "type": "string", "description": "Texto da pesquisa" },
    "filters": { "type": "object" },
    "maxResults": { "type": "number", "default": 10 }
  },
  "required": ["query"]
}
```
**Justificativa**: Schema Zod complexo, varia por skill, n√£o usado em WHERE

#### **2. responseSchema (JSONB)** ‚úÖ J√° est√° JSON
```json
{
  "type": "object",
  "properties": {
    "results": { "type": "array" },
    "totalFound": { "type": "number" },
    "source": { "type": "string" }
  }
}
```
**Justificativa**: Schema de resposta esperada, varia por skill

#### **3. metadata (JSONB)** - **‚ö†Ô∏è ADICIONAR SE N√ÉO EXISTE**
```json
{
  "icon": "Search",
  "color": "#3b82f6",
  "tags": ["pesquisa", "web", "rag"],
  "examples": [
    {
      "input": { "query": "IA generativa" },
      "expectedOutput": { "results": [...] }
    }
  ],
  "dependencies": ["rag_service", "search_api"],
  "pricing": {
    "costPerExecution": 0.01,
    "currency": "USD"
  },
  "documentation": {
    "url": "https://docs.example.com/skills/search",
    "changelog": "v1.2.0 - Adicionado filtro por data"
  }
}
```
**Justificativa**: 
- √çcone/cor usados na UI mas n√£o em queries SQL
- Tags extens√≠veis para categoriza√ß√£o
- Exemplos de uso (documenta√ß√£o)
- Depend√™ncias de servi√ßos externos
- Dados de precifica√ß√£o vari√°veis
- Links de documenta√ß√£o

---

## üîÑ MIGRA√á√ÉO RECOMENDADA

### **Schema Atual (Correto)**
```typescript
export const newSkill = pgTable("NewSkills", {
  // ‚úÖ Campos estruturais j√° est√£o como colunas
  id: uuid("id").primaryKey().defaultRandom(),
  name: varchar("name", { length: 100 }).notNull(),
  displayName: varchar("displayName", { length: 150 }),
  description: text("description").notNull(),
  companionId: uuid("companionId").notNull().references(() => newCompanion.id),
  organizationId: uuid("organizationId").references(() => organization.id),
  category: varchar("category", { length: 50 }),
  
  // ‚úÖ AI SDK 5.0 - Colunas corretas
  toolName: varchar("toolName", { length: 100 }).notNull(),
  toolSchema: jsonb("toolSchema").notNull(), // ‚úÖ JSON
  responseSchema: jsonb("responseSchema"), // ‚úÖ JSON
  toolDescription: text("toolDescription"),
  executionType: varchar("executionType", { length: 20 }).default("sync"),
  
  // ‚úÖ Configura√ß√µes - Colunas corretas
  maxRetries: integer("maxRetries").default(3),
  timeoutMs: integer("timeoutMs").default(30000),
  cacheable: boolean("cacheable").default(false),
  cacheExpiryMs: integer("cacheExpiryMs").default(300000),
  
  // ‚úÖ Performance - Colunas corretas
  avgExecutionTimeMs: numeric("avgExecutionTimeMs"),
  successRate: numeric("successRate"),
  errorRate: numeric("errorRate"),
  usageCount: integer("usageCount").default(0),
  lastUsed: timestamp("lastUsed"),
  
  // ‚úÖ Controle - Colunas corretas
  version: varchar("version", { length: 20 }).default("1.0.0"),
  isActive: boolean("isActive").default(true),
  isDeprecated: boolean("isDeprecated").default(false),
  
  // ‚úÖ MCP - Colunas corretas
  mcpIntegration: boolean("mcpIntegration").default(false),
  hasMcpMapping: boolean("hasMcpMapping").default(false),
  mcpServerId: uuid("mcpServerId").references(() => mcpServer.id),
  
  // ‚úÖ Auditoria - Colunas corretas
  createdAt: timestamp("createdAt").defaultNow(),
  updatedAt: timestamp("updatedAt").defaultNow(),
});
```

### **‚ö†Ô∏è AJUSTE RECOMENDADO**
**Adicionar campo `metadata` JSONB** para dados extens√≠veis:

```sql
ALTER TABLE "NewSkills" 
ADD COLUMN metadata JSONB DEFAULT '{}';
```

```typescript
export const newSkill = pgTable("NewSkills", {
  // ... campos existentes ...
  
  // ‚ú® NOVO: Metadados extens√≠veis
  metadata: jsonb("metadata").default({}),
});
```

---

## üìä √çNDICES RECOMENDADOS

```sql
-- ‚úÖ J√° existentes
CREATE INDEX idx_newskills_org ON new_skills(organization_id);
CREATE INDEX idx_newskills_active ON new_skills(skil_is_active) WHERE skil_is_active = TRUE;
CREATE INDEX idx_newskills_execution_type ON new_skills(skil_execution_type);
CREATE INDEX idx_newskills_usage ON new_skills(skil_usage_count DESC);
CREATE INDEX idx_newskills_performance ON new_skills(skil_success_rate DESC, skil_avg_execution_time_ms);
CREATE UNIQUE INDEX unique_skill_name_per_org ON new_skills(organization_id, skil_name);

-- ‚úÖ Adicionar se n√£o existir
CREATE INDEX idx_newskills_companion ON new_skills(companion_id);
CREATE INDEX idx_newskills_category ON new_skills(skil_category);
CREATE INDEX idx_newskills_last_used ON new_skills(skil_last_used DESC);

-- üîç √çndice GIN geral para skil_attributes
CREATE INDEX idx_newskills_attributes_gin ON new_skills USING GIN (skil_attributes);

-- üîç √çndices GIN para consultas espec√≠ficas em skil_attributes
CREATE INDEX idx_newskills_tool_schema ON new_skills USING GIN ((skil_attributes->'tool_schema'));
CREATE INDEX idx_newskills_metadata ON new_skills USING GIN ((skil_attributes->'metadata'));
```

---

## ‚úÖ CONCLUS√ÉO

### **‚úÖ Manter como COLUNAS:**
- Campos de identifica√ß√£o (id, name, toolName)
- Foreign keys (companionId, organizationId, mcpServerId)
- Campos de filtro/busca (category, isActive, executionType)
- M√©tricas de performance (usageCount, successRate, avgExecutionTimeMs)
- Configura√ß√µes de execu√ß√£o (timeoutMs, maxRetries, cacheable)
- Timestamps de auditoria (createdAt, updatedAt, lastUsed)

### **‚úÖ Manter como JSON:**
- toolSchema (schema Zod complexo)
- responseSchema (estrutura de resposta vari√°vel)

### **‚úÖ ADICIONAR como JSON:**
- **metadata** (√≠cone, cor, tags, exemplos, documenta√ß√£o, pricing)
  - Permite extensibilidade sem migrations
  - Dados de UI n√£o usados em queries SQL
  - Facilita evolu√ß√£o do sistema

---

## üéØ REGRAS DE DECIS√ÉO

| Crit√©rio | Coluna Fixa | JSON |
|----------|-------------|------|
| Usado em WHERE/JOIN | ‚úÖ | ‚ùå |
| Usado em ORDER BY | ‚úÖ | ‚ùå |
| Tem √≠ndice | ‚úÖ | ‚ùå |
| Foreign Key | ‚úÖ | ‚ùå |
| Estrutura vari√°vel | ‚ùå | ‚úÖ |
| Dados aninhados | ‚ùå | ‚úÖ |
| Extens√≠vel sem migration | ‚ùå | ‚úÖ |
| Busca full-text | ‚ùå | ‚úÖ (GIN) |

---

**Status**: ‚úÖ Schema atual est√° 95% correto. Apenas adicionar campo `metadata` JSONB.

