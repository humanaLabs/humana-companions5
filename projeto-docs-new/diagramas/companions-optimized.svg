<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 950" width="1400" height="950">
  <defs>
    <style>
      .table-box { fill: #ffffff; stroke: #2c3e50; stroke-width: 2; }
      .table-header { fill: #e67e22; stroke: none; }
      .table-title { fill: #ffffff; font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; }
      .field-text { fill: #2c3e50; font-family: 'Courier New', monospace; font-size: 13px; }
      .pk-field { fill: #e74c3c; font-weight: bold; }
      .fk-field { fill: #3498db; }
      .jsonb-field { fill: #f39c12; font-weight: bold; }
      .section-title { fill: #e67e22; font-family: Arial, sans-serif; font-size: 24px; font-weight: bold; }
      .note-box { fill: #fff3e0; stroke: #ff9800; stroke-width: 2; }
      .note-text { fill: #e65100; font-family: Arial, sans-serif; font-size: 12px; }
      .stats-box { fill: #ffebee; stroke: #f44336; stroke-width: 2; }
      .stats-text { fill: #c62828; font-family: Arial, sans-serif; font-size: 12px; font-weight: bold; }
      .relationship { stroke: #95a5a6; stroke-width: 2; fill: none; marker-end: url(#arrow); }
      .label { fill: #7f8c8d; font-family: Arial, sans-serif; font-size: 11px; font-style: italic; }
    </style>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#95a5a6" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="700" y="35" text-anchor="middle" class="section-title">
    COMPANIONS - Modelo T√©cnico v2.0 + Hierarquia Ag√™ntica
  </text>
  <text x="700" y="58" text-anchor="middle" style="fill: #7f8c8d; font-size: 13px; font-style: italic;">
    Estrutura: 9 campos header + 1 attributes JSONB (Redu√ß√£o: 26‚Üí10 campos, 62%)
  </text>

  <!-- Main Table -->
  <g id="companions">
    <rect class="table-box" x="50" y="90" width="550" height="420" rx="8"/>
    <rect class="table-header" x="50" y="90" width="550" height="40" rx="8"/>
    <text x="325" y="117" text-anchor="middle" class="table-title">COMPANIONS</text>
    
    <!-- Header Fields -->
    <text x="70" y="155" class="field-text" style="font-weight: bold; fill: #e67e22;">‚ñº HEADER (Colunas - Alta Frequ√™ncia)</text>
    <text x="70" y="180" class="field-text pk-field">üîë companion_id UUID PK</text>
    <text x="70" y="202" class="field-text fk-field">üîó workspace_id UUID FK</text>
    <text x="70" y="224" class="field-text fk-field">üîó organization_id UUID FK</text>
    <text x="70" y="246" class="field-text fk-field">üîó user_id UUID FK</text>
    <text x="70" y="268" class="field-text">‚Ä¢ companion_name VARCHAR(255) NOT NULL</text>
    <text x="70" y="290" class="field-text">‚Ä¢ companion_type ENUM (SUPER, FUNCTIONAL)</text>
    <text x="70" y="312" class="field-text">‚Ä¢ companion_instructions TEXT</text>
    <text x="70" y="334" class="field-text">‚Ä¢ companion_is_active BOOLEAN DEFAULT true</text>
    <text x="70" y="356" class="field-text">‚Ä¢ companion_created_at TIMESTAMP NOT NULL</text>
    
    <!-- Separator -->
    <line x1="70" y1="372" x2="580" y2="372" stroke="#95a5a6" stroke-width="2" stroke-dasharray="6"/>
    
    <!-- JSONB Field -->
    <text x="70" y="397" class="field-text" style="font-weight: bold; fill: #f39c12;">‚ñº ATTRIBUTES (JSONB - Baixa Frequ√™ncia)</text>
    <text x="70" y="422" class="field-text jsonb-field">üì¶ companion_attributes JSONB NOT NULL</text>
    <text x="90" y="447" class="field-text" style="font-size: 11px; fill: #7f8c8d;">   ‚îú‚îÄ role, description, domain, specialization</text>
    <text x="90" y="465" class="field-text" style="font-size: 11px; fill: #7f8c8d;">   ‚îú‚îÄ behavior {responsibilities, expertises, rules}</text>
    <text x="90" y="483" class="field-text" style="font-size: 11px; fill: #7f8c8d;">   ‚îú‚îÄ functions {think, execute, learn, analyze}</text>
    <text x="90" y="501" class="field-text" style="font-size: 11px; fill: #7f8c8d;">   ‚îî‚îÄ visibility, preferences, learningData, metadata</text>
  </g>

  <!-- Hierarchical Tables -->
  <g id="hierarchy">
    <rect class="table-box" x="650" y="90" width="700" height="200" rx="8"/>
    <rect class="table-header" x="650" y="90" width="700" height="40" rx="8"/>
    <text x="1000" y="117" text-anchor="middle" class="table-title">HIERARQUIA AG√äNTICA</text>
    
    <text x="670" y="155" class="field-text" style="font-weight: bold;">COMPANIONS (Agente Principal)</text>
    <text x="690" y="175" class="note-text">‚Üì 1:N</text>
    <text x="670" y="195" class="field-text" style="font-weight: bold;">SKILLS (Sub-agentes)</text>
    <text x="690" y="215" class="note-text">‚Üì 1:N</text>
    <text x="670" y="235" class="field-text" style="font-weight: bold;">STEPS (Fases de execu√ß√£o)</text>
    <text x="690" y="255" class="note-text">‚Üì 1:N</text>
    <text x="670" y="275" class="field-text" style="font-weight: bold;">EXECUTIONS (Workflows e logs)</text>
  </g>

  <!-- Stats Box -->
  <g id="stats">
    <rect class="stats-box" x="650" y="310" width="700" height="200" rx="8"/>
    <text x="1000" y="340" text-anchor="middle" class="stats-text" style="font-size: 16px;">
      üìä ESTAT√çSTICAS E GANHOS
    </text>
    
    <text x="670" y="370" class="stats-text">‚Ä¢ Campos: 26 ‚Üí 10 (62% redu√ß√£o - maior economia!)</text>
    <text x="670" y="393" class="stats-text">‚Ä¢ Performance listagens: +40-50% mais r√°pido</text>
    <text x="670" y="416" class="stats-text">‚Ä¢ Performance chat runtime: +30% mais r√°pido</text>
    <text x="670" y="439" class="stats-text">‚Ä¢ Escalabilidade: 10k+ companions</text>
    <text x="670" y="462" class="stats-text">‚Ä¢ √çndices: 7 principais + 4 JSONB condicionais</text>
    <text x="670" y="485" class="stats-text">‚Ä¢ Skills migr√°veis para tabela separada</text>
  </g>

  <!-- Benefits -->
  <g id="benefits">
    <rect class="note-box" x="50" y="540" width="1300" height="360" rx="8"/>
    <text x="700" y="570" text-anchor="middle" style="fill: #e65100; font-size: 18px; font-weight: bold;">
      ‚úÖ BENEF√çCIOS E DECIS√ïES T√âCNICAS
    </text>
    
    <text x="70" y="605" class="note-text" style="font-weight: bold;">üöÄ Performance:</text>
    <text x="90" y="628" class="note-text">‚Ä¢ Listagens: 250ms ‚Üí 100ms (60% ganho)</text>
    <text x="90" y="648" class="note-text">‚Ä¢ Chat runtime: 180ms ‚Üí 120ms (33% ganho - instructions como coluna TEXT)</text>
    <text x="90" y="668" class="note-text">‚Ä¢ RLS check: 50ms ‚Üí 15ms (70% ganho - organization_id direto)</text>
    <text x="90" y="688" class="note-text">‚Ä¢ Filtro por domain: 300ms ‚Üí 80ms (73% ganho - √≠ndice JSONB condicional)</text>
    
    <text x="70" y="723" class="note-text" style="font-weight: bold;">üéØ Decis√µes Fundamentadas:</text>
    <text x="90" y="746" class="note-text">1. organization_id redundante: ROI 1000:1 (156 KB vs 60% performance)</text>
    <text x="90" y="766" class="note-text">2. instructions como coluna: 30% mais r√°pido no chat (acesso sem JSONB parse)</text>
    <text x="90" y="786" class="note-text">3. Consolidar 17 JSONB em 1: simplifica schema, facilita evolu√ß√£o</text>
    <text x="90" y="806" class="note-text">4. companion_type ENUM: integridade + performance + autodocumenta√ß√£o</text>
    
    <text x="750" y="605" class="note-text" style="font-weight: bold;">ü§ñ Hierarquia Ag√™ntica:</text>
    <text x="770" y="628" class="note-text">‚Ä¢ Tabelas separadas: SKILLS, STEPS, EXECUTIONS</text>
    <text x="770" y="648" class="note-text">‚Ä¢ Functions migram de JSONB para Skills table</text>
    <text x="770" y="668" class="note-text">‚Ä¢ Orquestra√ß√£o clara via isOrchestrator</text>
    
    <text x="750" y="703" class="note-text" style="font-weight: bold;">‚öñÔ∏è Trade-offs Aceit√°veis:</text>
    <text x="770" y="726" class="note-text">‚Ä¢ Redund√¢ncia: organization_id (+16 bytes)</text>
    <text x="770" y="746" class="note-text">‚Ä¢ Migra√ß√£o: ~3h dev + 30min exec</text>
    <text x="770" y="766" class="note-text">‚Ä¢ Trigger: validate_companion_org (+5ms/insert)</text>
    <text x="770" y="786" class="note-text">‚Ä¢ Schema validator: zod schema (~2h dev)</text>
    
    <text x="70" y="831" class="note-text" style="font-weight: bold;">üìã √çndices JSONB Condicionais:</text>
    <text x="90" y="854" class="note-text">‚Ä¢ idx_companions_public: isPublic = true (30% queries)</text>
    <text x="90" y="874" class="note-text">‚Ä¢ idx_companions_domain: type = FUNCTIONAL (20% queries)</text>
  </g>

  <!-- Footer -->
  <text x="700" y="935" text-anchor="middle" style="fill: #95a5a6; font-size: 11px;">
    Modelo v2.0 - Alinhado com NOVO-MODELO-DADOS-HUMANA.svg + Rabisco_edu.jpeg - Documento: MODELO-TECNICO-COMPANIONS.md
  </text>
</svg>
