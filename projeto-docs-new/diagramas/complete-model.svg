<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1800 1200" width="1800" height="1200">
  <defs>
    <style>
      .table-box { fill: #ffffff; stroke: #2c3e50; stroke-width: 2; }
      .header-org { fill: #27ae60; }
      .header-user { fill: #3498db; }
      .header-companion { fill: #e67e22; }
      .header-shared { fill: #9b59b6; }
      .table-title { fill: #ffffff; font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; }
      .field-text { fill: #2c3e50; font-family: 'Courier New', monospace; font-size: 11px; }
      .pk-field { fill: #e74c3c; font-weight: bold; }
      .fk-field { fill: #3498db; }
      .jsonb-field { fill: #f39c12; font-weight: bold; }
      .relationship { stroke: #95a5a6; stroke-width: 2; fill: none; marker-end: url(#arrow); }
      .label { fill: #7f8c8d; font-family: Arial, sans-serif; font-size: 10px; font-style: italic; }
      .section-title { fill: #2c3e50; font-family: Arial, sans-serif; font-size: 26px; font-weight: bold; }
      .module-label { fill: #7f8c8d; font-family: Arial, sans-serif; font-size: 13px; font-weight: bold; }
      .note-box { fill: #ecf0f1; stroke: #95a5a6; stroke-width: 2; }
      .note-text { fill: #34495e; font-family: Arial, sans-serif; font-size: 11px; }
    </style>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#95a5a6" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="900" y="35" text-anchor="middle" class="section-title">
    MODELO COMPLETO - PLATAFORMA HUMANA COMPANIONS v2.0
  </text>
  <text x="900" y="60" text-anchor="middle" class="label" style="font-size: 13px;">
    Header + Attributes JSONB | Redução Média: 52% campos | Performance: +40-60%
  </text>

  <!-- MODULE 1: ORGANIZATIONS -->
  <text x="50" y="100" class="module-label" style="fill: #27ae60;">📊 ORGANIZATIONS (6 campos: 50% redução)</text>
  
  <g id="organizations">
    <rect class="table-box" x="50" y="115" width="320" height="215" rx="6"/>
    <rect class="header-org" x="50" y="115" width="320" height="30" rx="6"/>
    <text x="210" y="135" text-anchor="middle" class="table-title">ORGANIZATIONS</text>
    
    <text x="65" y="162" class="field-text pk-field">🔑 organization_id UUID PK</text>
    <text x="65" y="179" class="field-text">• organization_name VARCHAR(255)</text>
    <text x="65" y="196" class="field-text">• organization_created_at TIMESTAMP</text>
    <text x="65" y="213" class="field-text">• organization_updated_at TIMESTAMP</text>
    <text x="65" y="230" class="field-text">• organization_is_active BOOLEAN</text>
    <line x1="65" y1="240" x2="355" y2="240" stroke="#95a5a6" stroke-dasharray="3"/>
    <text x="65" y="257" class="field-text jsonb-field">📦 organization_attributes JSONB</text>
    <text x="85" y="274" class="field-text" style="font-size: 9px; fill: #7f8c8d;">structure, culture, subscription</text>
    <text x="85" y="290" class="field-text" style="font-size: 9px; fill: #7f8c8d;">branding, tenantConfig, access</text>
    <text x="85" y="310" class="field-text" style="font-size: 9px; font-style: italic;">🎯 5 header + JSONB</text>
  </g>

  <!-- MODULE 2: USERS -->
  <text x="420" y="100" class="module-label" style="fill: #3498db;">👤 USERS (9 campos: 44% redução)</text>
  
  <g id="users">
    <rect class="table-box" x="420" y="115" width="340" height="230" rx="6"/>
    <rect class="header-user" x="420" y="115" width="340" height="30" rx="6"/>
    <text x="590" y="135" text-anchor="middle" class="table-title">USERS</text>
    
    <text x="435" y="162" class="field-text pk-field">🔑 user_id UUID PK</text>
    <text x="435" y="179" class="field-text">• user_email VARCHAR(255) UNIQUE</text>
    <text x="435" y="196" class="field-text">• user_name VARCHAR(255)</text>
    <text x="435" y="213" class="field-text fk-field">🔗 organization_id UUID FK</text>
    <text x="435" y="230" class="field-text">• user_role_code ENUM (MS,OA,WM,UR)</text>
    <text x="435" y="247" class="field-text">• user_invite_code, timestamps</text>
    <line x1="435" y1="257" x2="745" y2="257" stroke="#95a5a6" stroke-dasharray="3"/>
    <text x="435" y="274" class="field-text jsonb-field">📦 user_attributes JSONB</text>
    <text x="455" y="291" class="field-text" style="font-size: 9px; fill: #7f8c8d;">profile, auth, subscription</text>
    <text x="455" y="307" class="field-text" style="font-size: 9px; fill: #7f8c8d;">preferences, stats, notifications</text>
    <text x="455" y="327" class="field-text" style="font-size: 9px; font-style: italic;">🎯 8 header + JSONB</text>
  </g>

  <!-- MODULE 3: WORKSPACES -->
  <text x="810" y="100" class="module-label" style="fill: #9b59b6;">💼 WORKSPACES (6 campos)</text>
  
  <g id="workspaces">
    <rect class="table-box" x="810" y="115" width="340" height="195" rx="6"/>
    <rect class="header-shared" x="810" y="115" width="340" height="30" rx="6"/>
    <text x="980" y="135" text-anchor="middle" class="table-title">WORKSPACES</text>
    
    <text x="825" y="162" class="field-text pk-field">🔑 workspace_id UUID PK</text>
    <text x="825" y="179" class="field-text fk-field">🔗 organization_id UUID FK</text>
    <text x="825" y="196" class="field-text">• workspace_name VARCHAR(255)</text>
    <text x="825" y="213" class="field-text">• workspace_type ENUM</text>
    <text x="845" y="227" class="field-text" style="font-size: 9px;">(PERSONAL, FUNCTIONAL)</text>
    <text x="825" y="244" class="field-text">• workspace_is_default BOOLEAN</text>
    <line x1="825" y1="254" x2="1135" y2="254" stroke="#95a5a6" stroke-dasharray="3"/>
    <text x="825" y="271" class="field-text jsonb-field">📦 workspace_attributes JSONB</text>
    <text x="845" y="290" class="field-text" style="font-size: 9px; font-style: italic;">🎯 5 header + JSONB</text>
  </g>

  <!-- MODULE 4: COMPANIONS -->
  <text x="50" y="375" class="module-label" style="fill: #e67e22;">🤖 COMPANIONS (10 campos: 62% redução)</text>
  
  <g id="companions">
    <rect class="table-box" x="50" y="390" width="380" height="260" rx="6"/>
    <rect class="header-companion" x="50" y="390" width="380" height="30" rx="6"/>
    <text x="240" y="410" text-anchor="middle" class="table-title">COMPANIONS</text>
    
    <text x="65" y="437" class="field-text pk-field">🔑 companion_id UUID PK</text>
    <text x="65" y="454" class="field-text fk-field">🔗 workspace_id, organization_id</text>
    <text x="65" y="471" class="field-text fk-field">🔗 user_id UUID FK</text>
    <text x="65" y="488" class="field-text">• companion_name VARCHAR(255)</text>
    <text x="65" y="505" class="field-text">• companion_type ENUM</text>
    <text x="65" y="522" class="field-text">• companion_instructions TEXT</text>
    <text x="65" y="539" class="field-text">• companion_is_active, companion_created_at</text>
    <line x1="65" y1="549" x2="415" y2="549" stroke="#95a5a6" stroke-dasharray="3"/>
    <text x="65" y="566" class="field-text jsonb-field">📦 companion_attributes JSONB</text>
    <text x="85" y="583" class="field-text" style="font-size: 9px; fill: #7f8c8d;">behavior, functions, visibility</text>
    <text x="85" y="599" class="field-text" style="font-size: 9px; fill: #7f8c8d;">preferences, learningData</text>
    <text x="85" y="619" class="field-text" style="font-size: 9px; font-style: italic;">🎯 9 header + JSONB</text>
  </g>

  <!-- SKILLS -->
  <g id="skills">
    <rect class="table-box" x="480" y="390" width="320" height="120" rx="6"/>
    <rect class="header-companion" x="480" y="390" width="320" height="30" rx="6"/>
    <text x="640" y="410" text-anchor="middle" class="table-title">SKILLS</text>
    
    <text x="495" y="437" class="field-text pk-field">🔑 skill_id UUID PK</text>
    <text x="495" y="454" class="field-text fk-field">🔗 companion_id UUID FK</text>
    <text x="495" y="471" class="field-text">• skill_name, skill_goal, skill_instructions</text>
    <text x="495" y="488" class="field-text">• skill_execution_order INT</text>
  </g>

  <!-- STEPS -->
  <g id="steps">
    <rect class="table-box" x="480" y="530" width="320" height="120" rx="6"/>
    <rect class="header-companion" x="480" y="530" width="320" height="30" rx="6"/>
    <text x="640" y="550" text-anchor="middle" class="table-title">STEPS</text>
    
    <text x="495" y="577" class="field-text pk-field">🔑 step_id UUID PK</text>
    <text x="495" y="594" class="field-text fk-field">🔗 skill_id UUID FK</text>
    <text x="495" y="611" class="field-text">• step_name, step_instructions TEXT</text>
    <text x="495" y="628" class="field-text">• step_order INTEGER</text>
  </g>

  <!-- SHARED MODULES -->
  <text x="860" y="375" class="module-label" style="fill: #9b59b6;">📚 MÓDULOS COMPARTILHADOS</text>
  
  <!-- CHATS -->
  <g id="chats">
    <rect class="table-box" x="860" y="390" width="320" height="130" rx="6"/>
    <rect class="header-shared" x="860" y="390" width="320" height="30" rx="6"/>
    <text x="1020" y="410" text-anchor="middle" class="table-title">CHATS</text>
    
    <text x="875" y="437" class="field-text pk-field">🔑 chat_id UUID PK</text>
    <text x="875" y="454" class="field-text fk-field">🔗 user_id, workspace_id</text>
    <text x="875" y="471" class="field-text fk-field">🔗 companion_id UUID FK</text>
    <text x="875" y="488" class="field-text">• chat_title VARCHAR(255)</text>
    <text x="875" y="505" class="field-text jsonb-field">📦 chat_messages JSONB[]</text>
  </g>

  <!-- KNOWLEDGE_RAG -->
  <g id="knowledge_rag">
    <rect class="table-box" x="860" y="540" width="320" height="160" rx="6"/>
    <rect class="header-shared" x="860" y="540" width="320" height="30" rx="6"/>
    <text x="1020" y="560" text-anchor="middle" class="table-title">KNOWLEDGE_RAG</text>
    
    <text x="875" y="587" class="field-text pk-field">🔑 knowledge_id UUID PK</text>
    <text x="875" y="604" class="field-text">• knowledge_resource_kind, knowledge_resource_id</text>
    <text x="875" y="621" class="field-text">• knowledge_class_info, knowledge_restricts_stamps</text>
    <text x="875" y="638" class="field-text">• knowledge_content TEXT</text>
    <text x="875" y="655" class="field-text">• knowledge_embedding VECTOR(1536)</text>
    <text x="875" y="672" class="field-text">• knowledge_chunk_index, knowledge_created_at</text>
  </g>

  <!-- WORKSPACE_USERS -->
  <g id="workspace_users">
    <rect class="table-box" x="1230" y="390" width="320" height="130" rx="6"/>
    <rect class="header-shared" x="1230" y="390" width="320" height="30" rx="6"/>
    <text x="1390" y="410" text-anchor="middle" class="table-title">WORKSPACE_USERS</text>
    
    <text x="1245" y="437" class="field-text pk-field">🔑 workspace_user_id UUID PK</text>
    <text x="1245" y="454" class="field-text fk-field">🔗 workspace_id UUID FK</text>
    <text x="1245" y="471" class="field-text fk-field">🔗 user_id UUID FK</text>
    <text x="1245" y="488" class="field-text">• workspace_user_role VARCHAR(50)</text>
    <text x="1245" y="505" class="field-text">• workspace_user_is_active BOOLEAN</text>
  </g>

  <!-- PERMISSIONS_ACL -->
  <g id="permissions_acl">
    <rect class="table-box" x="1230" y="540" width="320" height="160" rx="6"/>
    <rect class="header-shared" x="1230" y="540" width="320" height="30" rx="6"/>
    <text x="1390" y="560" text-anchor="middle" class="table-title">PERMISSIONS_ACL</text>
    
    <text x="1245" y="587" class="field-text pk-field">🔑 permission_id UUID PK</text>
    <text x="1245" y="604" class="field-text">• permission_resource_kind, permission_resource_id</text>
    <text x="1245" y="621" class="field-text">• permission_action ENUM (REA,WRI,UPD)</text>
    <text x="1245" y="638" class="field-text fk-field">🔗 user_id UUID FK</text>
    <text x="1245" y="655" class="field-text">• permission_valid_from, permission_valid_to</text>
    <text x="1245" y="672" class="field-text">• permission_is_active BOOLEAN</text>
  </g>

  <!-- Relationships -->
  
  <!-- Org → Users -->
  <path class="relationship" d="M 370 210 L 420 210"/>
  <text x="395" y="205" class="label">1:N</text>

  <!-- Org → Workspaces -->
  <path class="relationship" d="M 370 170 L 395 170 L 395 200 L 810 200"/>
  <text x="590" y="195" class="label">1:N</text>

  <!-- Users → Workspaces (via workspace_users) -->
  <path class="relationship" d="M 760 240 L 1200 240 L 1200 455 L 1230 455"/>
  <text x="980" y="235" class="label">N:M (via workspace_users)</text>

  <!-- Workspaces → Companions -->
  <path class="relationship" d="M 810 250 L 780 250 L 780 360 L 240 360 L 240 390"/>
  <text x="500" y="355" class="label">1:N</text>

  <!-- Users → Companions -->
  <path class="relationship" d="M 590 345 L 590 370 L 350 370 L 350 390"/>
  <text x="470" y="365" class="label">1:N (created_by)</text>

  <!-- Companions → Skills -->
  <path class="relationship" d="M 430 450 L 480 450"/>
  <text x="455" y="445" class="label">1:N</text>

  <!-- Skills → Steps -->
  <path class="relationship" d="M 640 510 L 640 530"/>
  <text x="650" y="523" class="label">1:N</text>

  <!-- Users → Chats -->
  <path class="relationship" d="M 760 230 L 790 230 L 790 455 L 860 455"/>
  <text x="825" y="342" class="label">1:N</text>

  <!-- Companions → Chats -->
  <path class="relationship" d="M 430 520 L 840 520 L 840 455 L 860 455"/>
  <text x="635" y="515" class="label">N:1</text>

  <!-- Org → Knowledge_RAG -->
  <path class="relationship" d="M 370 280 L 800 280 L 800 620 L 860 620"/>
  <text x="615" y="275" class="label">1:N</text>

  <!-- Companions → Knowledge_RAG -->
  <path class="relationship" d="M 430 590 L 820 590 L 820 620 L 860 620"/>
  <text x="625" y="585" class="label">1:N</text>

  <!-- Users → Permissions -->
  <path class="relationship" d="M 760 260 L 1210 260 L 1210 620 L 1230 620"/>
  <text x="995" y="255" class="label">1:N</text>

  <!-- Summary Section -->
  <g id="summary">
    <rect class="note-box" x="50" y="730" width="1700" height="420" rx="8"/>
    <text x="900" y="765" text-anchor="middle" style="fill: #2c3e50; font-size: 22px; font-weight: bold;">
      📊 RESUMO EXECUTIVO - MODELO OTIMIZADO v2.0
    </text>
    
    <!-- Column 1 -->
    <text x="70" y="805" class="note-text" style="font-weight: bold; font-size: 13px;">📋 ESTRUTURA CONSOLIDADA:</text>
    <text x="90" y="828" class="note-text">• <text style="fill: #27ae60; font-weight: bold;">ORGANIZATIONS:</text> 5 campos + attributes (12→6, 50% redução)</text>
    <text x="90" y="848" class="note-text">• <text style="fill: #3498db; font-weight: bold;">USERS:</text> 8 campos + attributes (16→9, 44% redução)</text>
    <text x="90" y="868" class="note-text">• <text style="fill: #e67e22; font-weight: bold;">COMPANIONS:</text> 9 campos + attributes (26→10, 62% redução)</text>
    <text x="90" y="888" class="note-text">• <text style="fill: #9b59b6; font-weight: bold;">WORKSPACES:</text> 5 campos + attributes</text>
    <text x="90" y="908" class="note-text">• Média geral: <text style="font-weight: bold;">52% de redução de campos</text></text>
    
    <text x="70" y="943" class="note-text" style="font-weight: bold; font-size: 13px;">🎯 CRITÉRIOS DE DECISÃO:</text>
    <text x="90" y="966" class="note-text">✓ <text style="font-weight: bold;">COLUNAS (Header):</text> WHERE, JOIN, ORDER BY, listagens, auth, runtime</text>
    <text x="90" y="986" class="note-text">✓ <text style="font-weight: bold;">JSONB (Attributes):</text> Raramente filtrados, features específicas, metadados</text>
    
    <text x="70" y="1021" class="note-text" style="font-weight: bold; font-size: 13px;">🔗 RELACIONAMENTOS:</text>
    <text x="90" y="1044" class="note-text">• Multi-tenancy: Organizations 1:N (Users, Workspaces, Companions)</text>
    <text x="90" y="1064" class="note-text">• Workspace isolation: Workspaces 1:N Companions, N:M Users (workspace_users)</text>
    <text x="90" y="1084" class="note-text">• Hierarquia agêntica: Companions 1:N Skills 1:N Steps</text>
    <text x="90" y="1104" class="note-text">• Conhecimento: Organizations/Companions 1:N Knowledge_RAG</text>
    <text x="90" y="1124" class="note-text">• Permissões: Users 1:N Permissions_ACL (ACL granular)</text>
    
    <!-- Column 2 -->
    <text x="950" y="805" class="note-text" style="font-weight: bold; font-size: 13px;">🚀 PERFORMANCE GANHOS:</text>
    <text x="970" y="828" class="note-text">• Organizations: Listagens +56%, Seletor +60%</text>
    <text x="970" y="848" class="note-text">• Users: Auth +50%, Listagens +40%, RBAC +67%</text>
    <text x="970" y="868" class="note-text">• Companions: Listagens +60%, Chat runtime +30%</text>
    <text x="970" y="888" class="note-text">• RLS overhead: -70% (organization_id direto)</text>
    <text x="970" y="908" class="note-text">• Índices: 40-58% menores → mais cache hits</text>
    
    <text x="950" y="943" class="note-text" style="font-weight: bold; font-size: 13px;">📈 ESCALABILIDADE:</text>
    <text x="970" y="966" class="note-text">• 10k+ orgs | 100k+ users | 10k+ companions</text>
    <text x="970" y="986" class="note-text">• Particionamento por organization_id: 100x mais rápido</text>
    <text x="970" y="1006" class="note-text">• Multi-tenancy otimizado (RLS + GUC)</text>
    
    <text x="950" y="1041" class="note-text" style="font-weight: bold; font-size: 13px;">🔒 SEGURANÇA E RBAC:</text>
    <text x="970" y="1064" class="note-text">• GUC (SET LOCAL): organization_id, workspace_id, role_code</text>
    <text x="970" y="1084" class="note-text">• RLS aplicado em TODAS as tabelas</text>
    <text x="970" y="1104" class="note-text">• RBAC: role_code (MS, OA, WM, UR) - 4 níveis</text>
    <text x="970" y="1124" class="note-text">• ACL granular: PERMISSIONS_ACL (resource-level)</text>
  </g>

  <!-- Footer -->
  <text x="900" y="1180" text-anchor="middle" style="fill: #95a5a6; font-size: 11px;">
    Modelo Completo v2.0 - Alinhado com NOVO-MODELO-DADOS-HUMANA.svg - Documentos: MODELO-TECNICO-*.md
  </text>
</svg>
